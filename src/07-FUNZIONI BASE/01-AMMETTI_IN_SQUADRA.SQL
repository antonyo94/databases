--FUNZIONE DI BASE 1
--Viene automatizzato l'inserimento in squadra degli allievi rispettando la loro etÃ  e la categoria che loro spetta.
--TABELLE COINVOLTE: ALLIEVO,GIOCA_IN
--USER: Mister

CREATE OR REPLACE PROCEDURE AMMETTI_IN_SQUADRA(NUM_TESSERA CHAR,CATEGORIA VARCHAR,ETA NUMBER,TITOLARE CHAR,RUOLO VARCHAR) IS
DATA_NASCITA DATE;
ETA_ALLIEVO NUMBER;
NON_AMMESSO EXCEPTION;

BEGIN
SELECT DATA_N INTO DATA_NASCITA
FROM ALLIEVO A
WHERE N_TESSERINO=NUM_TESSERA;

SELECT OTTIENI_ETA(DATA_NASCITA) INTO ETA_ALLIEVO
FROM DUAL;
IF ETA_ALLIEVO > ETA THEN 
RAISE NON_AMMESSO;
ELSE
INSERT INTO GIOCA_IN VALUES(NUM_TESSERA,CATEGORIA,ETA,TITOLARE,RUOLO);
END IF;

EXCEPTION
WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20409,'Allievo non iscritto');
WHEN NON_AMMESSO THEN RAISE_APPLICATION_ERROR(-20410,'Allievo troppo grande per la categoria ' || categoria || ',' ||eta);
COMMIT;
END;
