--TRIGGER 11
--Questo trigger controlla che nel caso in cui viene concesso ad un allievo di giocare in una categoria più grande della sua
--eta,questa non sia troppo piccola.Ovvero non permette ad allievi di giocare come sottoetà con due anni di differenza.
CREATE OR REPLACE TRIGGER TROPPO_PICCOLO_CAT
BEFORE INSERT OR  UPDATE OF CATEGORIA_S_GIOCA,ETA_S_GIOCA ON GIOCA_IN
FOR EACH ROW

DECLARE 
ETA_ALLIEVO NUMBER;
DATA_NASCITA DATE;
DIFFERENZA NUMBER;
NON_AMMESSO EXCEPTION;

BEGIN 
SELECT DATA_N INTO DATA_NASCITA
FROM ALLIEVO
WHERE N_TESSERINO=:NEW.N_TESSERINO_GIOCA;
SELECT OTTIENI_ETA(DATA_NASCITA) INTO ETA_ALLIEVO
FROM DUAL;
SELECT ABS(:NEW.ETA_S_GIOCA - ETA_ALLIEVO) INTO DIFFERENZA
FROM DUAL;

IF (DIFFERENZA)>=2 THEN 
RAISE NON_AMMESSO;
END IF;

EXCEPTION
WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-23300,'Allievo non iscritto');
WHEN NON_AMMESSO THEN RAISE_APPLICATION_ERROR(-20566,'Allievo troppo piccolo per la categoria ');

END;
