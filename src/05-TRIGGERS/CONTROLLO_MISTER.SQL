--TRIGGER 3
--Viene controllato che il mister cui viene affidata una squadra abbia la qualifica necessaria
CREATE OR REPLACE TRIGGER CONTROLLO_MISTER
BEFORE INSERT OR UPDATE OF N_PATENTINO_SQUADRA ON SQUADRA
FOR EACH ROW
DECLARE
QUALIFICA_MISTER QUALIFICA_M.QUALIFICA%TYPE;
NON_QUALIFICATO EXCEPTION;

BEGIN
SELECT QUALIFICA INTO QUALIFICA_MISTER
FROM MISTER M,QUALIFICA_M Q
WHERE M.N_PATENTINO=:NEW.N_PATENTINO_SQUADRA
	AND M.N_PATENTINO=Q.N_PATENTINO_QUALIFICA;
IF :NEW.CATEGORIA_S = 'GIOVANISSIMI' AND (QUALIFICA_MISTER<>'UEFA-B') THEN
	RAISE NON_QUALIFICATO;
END IF;
IF :NEW.CATEGORIA_S = 'ESORDIENTI' AND (QUALIFICA_MISTER<>'UEFA-B')	THEN
	RAISE NON_QUALIFICATO;
END IF;
IF :NEW.CATEGORIA_S = 'PULCINI' AND (QUALIFICA_MISTER<>'FIGC' AND QUALIFICA_MISTER <> 'UEFA-B')	THEN
	RAISE NON_QUALIFICATO;
END IF;
IF :NEW.CATEGORIA_S = 'PICCOLI AMICI' AND (QUALIFICA_MISTER <> 'FIGC' AND QUALIFICA_MISTER <> 'UEFA-B' AND QUALIFICA_MISTER <> 'DIPLOMA')	THEN
	RAISE NON_QUALIFICATO;
END IF;

EXCEPTION
WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20201,'Il mister non dispone di alcuna qualifica');
WHEN NON_QUALIFICATO THEN RAISE_APPLICATION_ERROR(-20200,'Il mister non dispone della qualidica adatta per allenare questa categoria');
END;