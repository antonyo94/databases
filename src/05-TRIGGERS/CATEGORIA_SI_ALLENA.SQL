--TRIGGER 5
--Viene effettuato un controllo dinamico per stabilire che ogni allievo debba allenarsi con la propria categoria di appartenenza
CREATE OR REPLACE TRIGGER CATEGORIA_SI_ALLENA
BEFORE INSERT ON SOSTIENE
FOR EACH ROW
DECLARE
CATEGORIA_ALLENAMENTO ALLENAMENTO.CATEGORIA_S_ALLENAMENTO%TYPE;
ETA_ALLENAMENTO ALLENAMENTO.ETA_S_ALLENAMENTO%TYPE;
CATEGORIA_GIOCA GIOCA_IN.CATEGORIA_S_GIOCA%TYPE;
ETA_GIOCA	GIOCA_IN.ETA_S_GIOCA%TYPE;
NON_SUA_CATEGORIA EXCEPTION;

BEGIN
SELECT CATEGORIA_S_ALLENAMENTO,ETA_S_ALLENAMENTO INTO CATEGORIA_ALLENAMENTO,ETA_ALLENAMENTO
FROM ALLENAMENTO
WHERE DATA_ALL= :NEW.DATA_ALL_SOSTIENE;

SELECT CATEGORIA_S_GIOCA,ETA_S_GIOCA INTO CATEGORIA_GIOCA,ETA_GIOCA
FROM GIOCA_IN
WHERE N_TESSERINO_GIOCA=:NEW.N_TESSERINO_SOSTIENE;

IF CATEGORIA_ALLENAMENTO <> CATEGORIA_GIOCA OR ETA_ALLENAMENTO <> ETA_GIOCA THEN
	RAISE NON_SUA_CATEGORIA;
END IF;

EXCEPTION
WHEN NON_SUA_CATEGORIA THEN 
	RAISE_APPLICATION_ERROR(-20345,'L''allievo non deve allenarsi con una categoria diversa dalla sua!');
END;