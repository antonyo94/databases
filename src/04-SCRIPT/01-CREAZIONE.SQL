CREATE USER ADMINSCUOLA IDENTIFIED BY ADMIN;
GRANT DBA TO ADMINSCUOLA;


--Creazione delle tabelle necessarie per il DB della Scuola Calcio
DROP TABLE GENITORE;
DROP TABLE TELEFONO_G;
DROP TABLE ALLIEVO;
DROP TABLE PAGAMENTO;
DROP TABLE DIRIGENTE;
DROP TABLE GIOCA_IN;
DROP TABLE SQUADRA;
DROP TABLE MISTER;
DROP TABLE QUALIFICA;
DROP TABLE ALLENAMENTO;
DROP TABLE SOSTIENE;


--GENITORE
CREATE TABLE GENITORE (
	CF_G CHAR(7),
	NOME_G VARCHAR2(15),
	COGNOME_G VARCHAR2(15),
	RUOLO_G VARCHAR2(15)  NOT NULL,
	CONSTRAINT GENITORE_PK PRIMARY KEY (CF_G),
	CONSTRAINT DEFINIZIONE_RUOLO CHECK(UPPER(RUOLO_G) IN ('MADRE','PADRE'))
);

--TELEFONO GENITORE
CREATE TABLE TELEFONO_G (
	CF_G_TELEFONO CHAR(7) ,
	TELEFONO_G NUMBER(10,0) UNIQUE,
	CONSTRAINT TELEFONO_G_PK PRIMARY KEY(CF_G_TELEFONO,TELEFONO_G),
	CONSTRAINT TELEFONO_G_FK FOREIGN KEY(CF_G_TELEFONO) REFERENCES GENITORE(CF_G) ON DELETE CASCADE
);

--ALLIEVO
CREATE TABLE ALLIEVO (
	N_TESSERINO CHAR(7),
	CF_G_ALLIEVO CHAR(7) NOT NULL,
	NOME_A VARCHAR2(15),
	COGNOME_A VARCHAR2(15),
	DATA_N DATE,
	VIA_A VARCHAR2(10),
	CAP_A CHAR(5),
	CITTA_A VARCHAR2(10),	
	CONSTRAINT ALLIEVO_PK PRIMARY KEY (N_TESSERINO),
	CONSTRAINT ALLIEVO_FK FOREIGN KEY (CF_G_ALLIEVO) REFERENCES GENITORE(CF_G)
);

--DIRIGENTE
CREATE TABLE DIRIGENTE(
CF_D CHAR(7),
NOME_D VARCHAR2(15),
COGNOME_D VARCHAR2(15),
RUOLO VARCHAR2(15) NOT NULL,
SETTORE VARCHAR2(15),
DATA_ASSUNZIONE DATE,
CONSTRAINT DIRIGENTE_PK PRIMARY KEY (CF_D),
CONSTRAINT CONTROLLO_RUOLO CHECK(UPPER(RUOLO)IN('PRESIDENTE','SEGRETARIA','COLLABORATORE')),
CONSTRAINT CONTROLLO_SETTORE CHECK(UPPER(SETTORE) IN('SPORTIVO','AMMINISTRATIVO'))
);

--PAGAMENTO
CREATE TABLE PAGAMENTO(
ID_P VARCHAR2(7),
N_TESSERINO_PAGAMENTO CHAR(7) NOT NULL,
CF_D_PAGAMENTO CHAR(7) NOT NULL,
DATA_P DATE,
IMPORTO_P NUMBER DEFAULT(25),
CONSTRAINT PAGAMENTO_PK PRIMARY KEY(ID_P),
CONSTRAINT PAGAMENTO_FK1 FOREIGN KEY(N_TESSERINO_PAGAMENTO) REFERENCES ALLIEVO(N_TESSERINO),
CONSTRAINT PAGAMENTO_FK2 FOREIGN KEY(CF_D_PAGAMENTO) REFERENCES DIRIGENTE(CF_D),
CONSTRAINT CONTROLLO_IMPORTO CHECK(IMPORTO_P>=25 AND IMPORTO_P <=100)
);

--MISTER
CREATE TABLE MISTER(
N_PATENTINO CHAR(7),
NOME_M VARCHAR2(15),
COGNOME_M VARCHAR2(15),
DATA_N_M DATE,
CONSTRAINT MISTER_PK PRIMARY KEY(N_PATENTINO)
);

--QUALIFICA MISTER
CREATE TABLE QUALIFICA_M(
N_PATENTINO_QUALIFICA CHAR(7) NOT NULL,
QUALIFICA VARCHAR2(15),
CONSTRAINT QUALIFICA_M_PK PRIMARY KEY(N_PATENTINO_QUALIFICA,QUALIFICA),
CONSTRAINT QUALIFICA_M_FK FOREIGN KEY(N_PATENTINO_QUALIFICA) REFERENCES MISTER(N_PATENTINO) ON DELETE CASCADE
);

--SQUADRA 
CREATE TABLE SQUADRA(
CATEGORIA_S VARCHAR2(15),
ETA_S NUMBER(2,0),
N_PATENTINO_SQUADRA CHAR(7) ,
CONSTRAINT SQUADRA_PK PRIMARY KEY(CATEGORIA_S,ETA_S),
CONSTRAINT SQUADRA_FK FOREIGN KEY(N_PATENTINO_SQUADRA) REFERENCES MISTER(N_PATENTINO),
CONSTRAINT CONTROLLO_ETA CHECK((ETA_S>=5 AND ETA_S<7 AND UPPER(CATEGORIA_S)IN 'PICCOLI AMICI') OR 
							  (ETA_S>=7 AND ETA_S<9 AND UPPER(CATEGORIA_S) IN('PULCINI'))      OR 
							  (ETA_S>=9 AND ETA_S<12 AND UPPER(CATEGORIA_S)IN 'ESORDIENTI')    OR 
							  (ETA_S>=12 AND ETA_S<=14 AND UPPER(CATEGORIA_S)IN 'GIOVANISSIMI'))
);

--GIOCA IN
CREATE TABLE GIOCA_IN(
N_TESSERINO_GIOCA CHAR(7) ,
CATEGORIA_S_GIOCA VARCHAR2(15) ,
ETA_S_GIOCA NUMBER(2,0),
TITOLARE CHAR(2) DEFAULT('NO'),
RUOLO VARCHAR(15),
CONSTRAINT GIOCA_IN_PK PRIMARY KEY(N_TESSERINO_GIOCA,CATEGORIA_S_GIOCA,ETA_S_GIOCA),
CONSTRAINT GIOCA_IN_FK1 FOREIGN KEY(N_TESSERINO_GIOCA) REFERENCES ALLIEVO(N_TESSERINO) ON DELETE CASCADE,
CONSTRAINT GIOCA_IN_FK2 FOREIGN KEY(CATEGORIA_S_GIOCA,ETA_S_GIOCA) REFERENCES SQUADRA(CATEGORIA_S,ETA_S) ON DELETE CASCADE,
CONSTRAINT SI_NO CHECK(UPPER(TITOLARE) IN('SI','NO')),
CONSTRAINT CONTROLLO_RUOLO_G CHECK(UPPER(RUOLO) IN ('PORTIERE','DIFENSORE','CENTROCAMPISTA','ATTACCANTE'))
);


--ALLENAMENTO
CREATE TABLE ALLENAMENTO(
DATA_ALL DATE,
N_PATENTINO_ALLENAMENTO CHAR(7),
CATEGORIA_S_ALLENAMENTO VARCHAR2(15),
ETA_S_ALLENAMENTO NUMBER(2,0) ,
DURATA NUMBER(3,0) NOT NULL,
CONSTRAINT ALLENAMENTO_PK PRIMARY KEY(DATA_ALL),
CONSTRAINT ALLENAMENTO_FK_1 FOREIGN KEY (N_PATENTINO_ALLENAMENTO) REFERENCES MISTER(N_PATENTINO),
CONSTRAINT ALLENAMENTO_FK_2 FOREIGN KEY (CATEGORIA_S_ALLENAMENTO,ETA_S_ALLENAMENTO) REFERENCES SQUADRA(CATEGORIA_S,ETA_S),
CONSTRAINT CONTROLLO_ETA_ALL CHECK((ETA_S_ALLENAMENTO>=5 AND ETA_S_ALLENAMENTO<7 AND UPPER(CATEGORIA_S_ALLENAMENTO)IN 'PICCOLI AMICI') OR 
								  (ETA_S_ALLENAMENTO>=7 AND ETA_S_ALLENAMENTO<9 AND UPPER(CATEGORIA_S_ALLENAMENTO) IN('PULCINI'))      OR 
							 	  (ETA_S_ALLENAMENTO>=9 AND ETA_S_ALLENAMENTO<12 AND UPPER(CATEGORIA_S_ALLENAMENTO)IN 'ESORDIENTI')    OR 
							 	  (ETA_S_ALLENAMENTO>=12 AND ETA_S_ALLENAMENTO<=14 AND UPPER(CATEGORIA_S_ALLENAMENTO)IN 'GIOVANISSIMI')),
CONSTRAINT VERIFICA_INS_ORA CHECK(TO_CHAR(DATA_ALL,'DD-MM-YYYY HH24:MI:SS') NOT LIKE '%00:00:00'),
CONSTRAINT MAX_DURATA CHECK(DURATA<=120)
);

--SOSTIENE
CREATE TABLE SOSTIENE(
N_TESSERINO_SOSTIENE CHAR(7),
DATA_ALL_SOSTIENE DATE,
RUOLO_SOSTIENE VARCHAR2(15)NOT NULL,
VOTO_SOSTIENE NUMBER(2,0) NOT NULL,
CONSTRAINT SOSTIENE_PK PRIMARY KEY(N_TESSERINO_SOSTIENE,DATA_ALL_SOSTIENE),
CONSTRAINT SOSTIENE_FK1 FOREIGN KEY(N_TESSERINO_SOSTIENE) REFERENCES ALLIEVO(N_TESSERINO) ON DELETE CASCADE,
CONSTRAINT SOSTIENE_FK2 FOREIGN KEY(DATA_ALL_SOSTIENE) REFERENCES ALLENAMENTO(DATA_ALL) ON DELETE CASCADE,
CONSTRAINT CONTROLLO_VOTO CHECK(VOTO_SOSTIENE>=0 AND VOTO_SOSTIENE<=10),
CONSTRAINT CONTROLLO_RUOLO_SOSTIENE CHECK(UPPER(RUOLO_SOSTIENE) IN ('PORTIERE','DIFENSORE','CENTROCAMPISTA','ATTACCANTE'))
);

--SEQUENZA UTILE PER I PAGAMENTI
CREATE  SEQUENCE PAGSEQ
  START WITH 1111111
  INCREMENT BY 1;