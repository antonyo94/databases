--PROCEDURA 4bis
--La seguente procedura appare come semplice modifica alla INSERISCI_UN_TITOLARE in cui vengono parzialmente gestite le eccezioni e non viene 
--effettuato alcun commit,questo per permettere che venga invocata dalla TITOLARI_CATEGORIA.
--TABELLE COINVOLTE: ALLIEVI,GIOCA_IN,SOSTIENE
--USER: E il mister a lanciare questa procedura,quando invoca la titolari_categoria()
CREATE OR REPLACE PROCEDURE INSERISCI_TITOLARE(NUM_TESSERA CHAR,CATEGORIA CHAR,ETA NUMBER,RUOLO_IN VARCHAR) IS
NUM_TITOLARI NUMBER:=0;
MIN_TITOLARE NUMBER:=0;
CUR_AVG NUMBER:=0;
NUM_ALLENAMENTI NUMBER:=0;
ALLIEVI_MIGLIORI EXCEPTION;
NESSUNA_ALLENAMENTO EXCEPTION;
BEGIN 

--CONTROLLA IL NUMERO DEI TITOLARI NEL RUOLO DEL NUOVO ALLIEVO CHE SI VUOLE FAR TITOLARE
SELECT COUNT(N_TESSERINO_GIOCA) INTO NUM_TITOLARI
FROM GIOCA_IN
WHERE CATEGORIA_S_GIOCA=CATEGORIA AND ETA_S_GIOCA=ETA AND RUOLO=RUOLO_IN AND TITOLARE='SI';

--CONTROLLA CHE L'ALLIEVO ABBIA FATTO ALMENO UN ALLENAMENTO IN QUESTO RUOLO NELL'ULTIMO MESE
SELECT COUNT(DATA_ALL_SOSTIENE) INTO NUM_ALLENAMENTI
FROM SOSTIENE
WHERE N_TESSERINO_SOSTIENE=NUM_TESSERA AND RUOLO_SOSTIENE=RUOLO_IN;
IF NUM_ALLENAMENTI=0 THEN 
	RAISE NESSUNA_ALLENAMENTO;
END IF;

--CONTROLLA LA MEDIA VOTO DEL NUOVO ALLIEVO DA INSERIRE TITOLARE IN QUEL RUOLO
SELECT AVG(VOTO_SOSTIENE) INTO CUR_AVG
FROM SOSTIENE
WHERE N_TESSERINO_SOSTIENE=NUM_TESSERA AND RUOLO_SOSTIENE=RUOLO_IN;

--CERCA MIN MEDIA VOTO TRA GLI ALLIEVI TITOLARI,SE CE NE SONO
IF NUM_TITOLARI>0 THEN
SELECT DISTINCT AVG(S1.VOTO_SOSTIENE) INTO MIN_TITOLARE
FROM ALLIEVO A1,SOSTIENE S1,GIOCA_IN G1
WHERE A1.N_TESSERINO=S1.N_TESSERINO_SOSTIENE AND G1.N_TESSERINO_GIOCA=A1.N_TESSERINO AND 
G1.CATEGORIA_S_GIOCA=CATEGORIA AND G1.ETA_S_GIOCA=ETA AND S1.RUOLO_SOSTIENE=RUOLO_IN AND G1.TITOLARE='SI'
AND G1.RUOLO=RUOLO_IN AND DATA_ALL_SOSTIENE BETWEEN SYSDATE-30 AND SYSDATE
GROUP BY A1.N_TESSERINO
HAVING AVG(S1.VOTO_SOSTIENE) = (SELECT MIN(AVG(S.VOTO_SOSTIENE))
								FROM ALLIEVO A,SOSTIENE S,GIOCA_IN G
								WHERE A.N_TESSERINO=S.N_TESSERINO_SOSTIENE AND G.N_TESSERINO_GIOCA=A.N_TESSERINO AND 
								G.CATEGORIA_S_GIOCA=CATEGORIA AND G.ETA_S_GIOCA=ETA AND S.RUOLO_SOSTIENE=RUOLO_IN AND G.TITOLARE='SI'
								AND G.RUOLO=RUOLO_IN AND DATA_ALL_SOSTIENE BETWEEN SYSDATE-30 AND SYSDATE
								GROUP BY A.N_TESSERINO);
END IF;
--VIENE ESEGUITO UN CONTROLLO SULL'ETA DEGLI ALLIEVI,PER GARANTIRE CHE CI SIANO 5 TITOLARI PER I BAMBINI AL DI SOTTO DEI 9 ANNI
--ED 11 TITOLARI PER RAGAZZI DAI 9 ANNI IN SU

IF ETA<9 THEN
	--IL NUMERO MAX DI PORTIERI E' UNO
	IF RUOLO_IN='PORTIERE' THEN
		IF NUM_TITOLARI=0 THEN
			UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
		ELSE
			IF CUR_AVG > MIN_TITOLARE THEN 
				  RIMUOVI_TITOLARE(CATEGORIA,ETA,RUOLO_IN);
				UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
			ELSE
				RAISE ALLIEVI_MIGLIORI;
			END IF;
		END IF;
	END IF;

	--IL NUMERO MASSIMO DI DIFENSORI PER BAMBINI E' DI DUE
	IF RUOLO_IN='DIFENSORE' THEN
		IF NUM_TITOLARI<2 THEN
			UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
		ELSE
			IF CUR_AVG > MIN_TITOLARE THEN 
				  RIMUOVI_TITOLARE(CATEGORIA,ETA,RUOLO_IN);
				UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
			ELSE
				RAISE ALLIEVI_MIGLIORI;
			END IF;
		END IF;
	END IF;

	--IL NUMERO MASSIMO DI CENTROCAMPISTI PER BAMBINI E' DI DUE
	IF RUOLO_IN='CENTROCAMPISTA' THEN
		IF NUM_TITOLARI<2 THEN
			UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
		ELSE
			IF CUR_AVG > MIN_TITOLARE THEN 
				  RIMUOVI_TITOLARE(CATEGORIA,ETA,RUOLO_IN);
				UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
			ELSE
				RAISE ALLIEVI_MIGLIORI;
			END IF;
		END IF;
	END IF;

	--IL NUMERO MASSIMO DI ATTACCANTI PER BAMBINI E' DUE
	IF RUOLO_IN='ATTACCANTE' THEN
		IF NUM_TITOLARI<1 THEN
			UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
		ELSE
			IF CUR_AVG > MIN_TITOLARE THEN 
				  RIMUOVI_TITOLARE(CATEGORIA,ETA,RUOLO_IN);
				UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
			ELSE
				RAISE ALLIEVI_MIGLIORI;
			END IF;
		END IF;
	END IF;
ELSE
	--IL NUMERO MAX DI PORTIERI E' UNO
	IF RUOLO_IN='PORTIERE' THEN
		IF NUM_TITOLARI=0 THEN
			UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
		ELSE
			IF CUR_AVG > MIN_TITOLARE THEN 
				  RIMUOVI_TITOLARE(CATEGORIA,ETA,RUOLO_IN);
				UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
			ELSE
				RAISE ALLIEVI_MIGLIORI;
			END IF;
		END IF;
	END IF;
		
	--IL NUMERO MASSIMO DI DIFENSORI PER RAGAZZI E' 4
	IF RUOLO_IN='DIFENSORE' THEN
		IF NUM_TITOLARI<4 THEN
			UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
		ELSE
			IF CUR_AVG > MIN_TITOLARE THEN 
				  RIMUOVI_TITOLARE(CATEGORIA,ETA,RUOLO_IN);
				UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
			ELSE
				RAISE ALLIEVI_MIGLIORI;
			END IF;
		END IF;
	END IF;

	--IL NUMERO MASSIMO DI CENTROCAMPISTI PER PER RAGAZZI E' 4
	IF RUOLO_IN='CENTROCAMPISTA' THEN
		IF NUM_TITOLARI<4 THEN
			UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
		ELSE
			IF CUR_AVG > MIN_TITOLARE THEN 
				  RIMUOVI_TITOLARE(CATEGORIA,ETA,RUOLO_IN);
				UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
			ELSE
				RAISE ALLIEVI_MIGLIORI;
			END IF;
		END IF;
	END IF;
	--IL NUMERO MASSIMO DI ATTACCANTI PER RAGAZZI E' 2
	IF RUOLO_IN='ATTACCANTE' THEN
		IF NUM_TITOLARI<2 THEN
			UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
		ELSE
			IF CUR_AVG > MIN_TITOLARE THEN 
				  RIMUOVI_TITOLARE(CATEGORIA,ETA,RUOLO_IN);
				UPDATE GIOCA_IN SET TITOLARE='SI',RUOLO=RUOLO_IN WHERE N_TESSERINO_GIOCA=NUM_TESSERA;
			ELSE
				RAISE ALLIEVI_MIGLIORI;
			END IF;
		END IF;
	END IF;
END IF;

EXCEPTION
WHEN ALLIEVI_MIGLIORI THEN NULL;
WHEN NESSUNA_ALLENAMENTO THEN NULL;
END;
