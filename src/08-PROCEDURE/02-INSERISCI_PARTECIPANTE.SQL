--PROCEDURA 2
--Viene data la possibilità ai mister di automatizzare l'inserimento dei partecipanti ad un allennamento,se essi risultano in regola,
--ovvero abbiano effettuato almeno un pagamento nell'ultimo mese.Se ciò non accade vengono elencati i recapiti appartenenti al genitore
--dell'allievo per avvisarlo dei mancati pagamenti.
--TABELLE COINVOLTE: ALLIEVO,GENITORE,TELEFONO_G,PAGAMENTO
--USER: Viene lanciata dai mister connessi al DB

CREATE OR REPLACE PROCEDURE INSERISCI_PARTECIPANTE(NUM_TESSERA CHAR,DATA DATE,RUOLO VARCHAR,VOTO NUMBER) IS
NUM_PAGAMENTI NUMBER;
CURSOR POINT IS(SELECT NOME_G,COGNOME_G,TELEFONO_G 
				FROM ALLIEVO A,GENITORE G,TELEFONO_G T
				WHERE G.CF_G=A.CF_G_ALLIEVO AND A.N_TESSERINO=NUM_TESSERA AND T.CF_G_TELEFONO=G.CF_G
				);
RECAPITI POINT%ROWTYPE;

BEGIN 
SELECT COUNT(ID_P) INTO NUM_PAGAMENTI
FROM PAGAMENTO
WHERE N_TESSERINO_PAGAMENTO=NUM_TESSERA AND DATA_P BETWEEN SYSDATE-45 AND SYSDATE;

IF NUM_PAGAMENTI>0 THEN
	INSERT INTO SOSTIENE VALUES(NUM_TESSERA,DATA,RUOLO,VOTO);
ELSE
DBMS_OUTPUT.PUT_LINE('Allievo non in regola con i pagamenti');
OPEN POINT;
LOOP
FETCH POINT INTO RECAPITI;
EXIT WHEN POINT%NOTFOUND;
DBMS_OUTPUT.PUT_LINE('Contattare '|| RECAPITI.NOME_G ||' '|| RECAPITI.COGNOME_G || ' al ' || RECAPITI.TELEFONO_G || ' per avvisarlo.');
END LOOP;
CLOSE POINT;
END IF;
COMMIT;
EXCEPTION
WHEN NO_DATA_FOUND THEN NULL;
END;
