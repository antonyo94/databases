--PROCEDURA 1
--Viene automatizzato il sistema di inserimento dei pagamenti controllando all'atto gli eventuali sconti dediti a tale allievo,
--che dipendono dal numero dei figli a carico del genitore di tale allievo.
--TABELLE COINVOLTE: ALLIEVO,GENITORE,PAGAMENTO
--USER: Viene lanciata dai dirigenti connessi al DB

CREATE OR REPLACE PROCEDURE INSERISCI_PAGAMENTO(NUM_TESSERA CHAR,ID_DIR CHAR,VALORE NUMBER) IS
NUM_FIGLI NUMBER;
IMPORTO NUMBER;
BEGIN
SELECT COUNT(*) INTO NUM_FIGLI
FROM ALLIEVO A,GENITORE G
WHERE G.CF_G IN (SELECT CF_G_ALLIEVO
				FROM ALLIEVO A,PAGAMENTO P				
				WHERE A.N_TESSERINO=NUM_TESSERA)
		AND G.CF_G=A.CF_G_ALLIEVO
GROUP BY G.CF_G;

SELECT CALCOLA_SCONTO(VALORE,NUM_FIGLI) INTO IMPORTO
FROM DUAL;
INSERT INTO PAGAMENTO VALUES(PAGSEQ.NEXTVAL,NUM_TESSERA,ID_DIR,SYSDATE,IMPORTO);

EXCEPTION 
WHEN NO_DATA_FOUND THEN DBMS_OUTPUT.PUT_LINE('Controlla numero dirigente/tesserino');
COMMIT;
END;
