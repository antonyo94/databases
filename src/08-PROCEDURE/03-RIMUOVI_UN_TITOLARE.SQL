--PROCEDURA 3
--Procedura utilizzata per rimuovere dai titolari di una categoria l'allievo che nell'ultimo mese ha la media minore degli allenamenti 
--sostenuti in quel determinato ruolo.
--TABELLE COINVOLTE: ALLIEVO,SOSTIENE,GIOCA_IN
--USER: Mister

CREATE OR REPLACE PROCEDURE RIMUOVI_UN_TITOLARE(CATEGORIA VARCHAR,ETA NUMBER,RUOLO_IN VARCHAR) IS
CURSOR PUNT IS 
SELECT N_TESSERINO_GIOCA
FROM GIOCA_IN
WHERE N_TESSERINO_GIOCA IN
	  (SELECT A.N_TESSERINO
	  FROM ALLIEVO A,SOSTIENE S,GIOCA_IN G
	  WHERE A.N_TESSERINO=S.N_TESSERINO_SOSTIENE AND G.N_TESSERINO_GIOCA=A.N_TESSERINO AND 
	  G.CATEGORIA_S_GIOCA=CATEGORIA AND G.ETA_S_GIOCA=ETA AND G.RUOLO=RUOLO_IN AND G.TITOLARE='SI'
	  AND	S.RUOLO_SOSTIENE=RUOLO_IN AND S.DATA_ALL_SOSTIENE BETWEEN SYSDATE-30 AND SYSDATE
	  GROUP BY A.N_TESSERINO
	  HAVING AVG(S.VOTO_SOSTIENE) IN (SELECT MIN(AVG(S1.VOTO_SOSTIENE))
			      FROM ALLIEVO A1,SOSTIENE S1,GIOCA_IN G1
			      WHERE A1.N_TESSERINO=S1.N_TESSERINO_SOSTIENE AND G1.N_TESSERINO_GIOCA=A1.N_TESSERINO AND 
	  				    G1.CATEGORIA_S_GIOCA=CATEGORIA AND G1.ETA_S_GIOCA=ETA AND G1.RUOLO=RUOLO_IN AND G1.TITOLARE='SI'
	  				    AND S1.RUOLO_SOSTIENE=RUOLO_IN	AND S1.DATA_ALL_SOSTIENE BETWEEN SYSDATE-30 AND SYSDATE
			      GROUP BY A1.N_TESSERINO))
FOR UPDATE OF TITOLARE,RUOLO;
TESSERINO_DA_RIMUOVERE PUNT%ROWTYPE;

BEGIN
OPEN PUNT;
LOOP
FETCH PUNT INTO TESSERINO_DA_RIMUOVERE;
EXIT WHEN PUNT%NOTFOUND;
UPDATE GIOCA_IN SET TITOLARE='NO',RUOLO=NULL
WHERE CURRENT OF PUNT;
END LOOP;
EXCEPTION
WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20200,'Non sono state trovate corrispondenze');
COMMIT;
END;

